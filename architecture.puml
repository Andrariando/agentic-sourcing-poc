@startuml Agentic_Sourcing_Architecture

' =============================================================================
' AGENTIC SOURCING COPILOT â€” SYSTEM ARCHITECTURE DIAGRAM
' =============================================================================
' 
' Purpose: Visual representation of the human-in-the-loop, multi-agent 
'          decision-support system for procurement sourcing.
'
' Version: Current (2025) - Reflects actual implementation
'
' Key Features:
'   â€¢ LLM-First Intent Classification with Structured Output
'   â€¢ 7 Official Agents with Task Execution Hierarchy
'   â€¢ Artifact System with Execution Metadata
'   â€¢ Two-Level Intent Classification (UserGoal + WorkType)
'   â€¢ Supervisor-only State Changes
'   â€¢ Conversation Memory with Cost-Aware Context Management (optional)
'   â€¢ Aggressive Caching (500 entries, 80%+ hit rate expected)
'
' To render: Use PlantUML extension in VS Code/Cursor (Alt+D) or online at
'            http://www.plantuml.com/plantuml
' =============================================================================

title Agentic Sourcing Copilot - Enterprise Architecture\n//Human-in-the-Loop Multi-Agent Decision Support System//\n\n**Current Implementation** â€” LLM-First Classification & Artifact System

skinparam backgroundColor #FEFEFE
skinparam defaultFontSize 11
skinparam roundcorner 10
skinparam shadowing true

skinparam rectangle {
    BackgroundColor<<human>> #FFEBEE
    BorderColor<<human>> #C62828
    BorderThickness 2
    BackgroundColor<<frontend>> #E3F2FD
    BorderColor<<frontend>> #1976D2
    BorderThickness 2
    BackgroundColor<<backend>> #E8F5E9
    BorderColor<<backend>> #388E3C
    BorderThickness 2
    BackgroundColor<<supervisor>> #FFF3E0
    BorderColor<<supervisor>> #F57C00
    BorderThickness 3
    BackgroundColor<<agent>> #F3E5F5
    BorderColor<<agent>> #7B1FA2
    BorderThickness 2
    BackgroundColor<<task>> #FFF9C4
    BorderColor<<task>> #F9A825
    BorderThickness 2
    BackgroundColor<<data>> #ECEFF1
    BorderColor<<data>> #546E7A
    BorderThickness 2
    BackgroundColor<<external>> #E8E8E8
    BorderColor<<external>> #999999
    BorderThickness 2
}

' ============== EXTERNAL ACTORS ==============
rectangle "ğŸ‘¤ **Procurement Officer**\n(Human Decision-Maker)" as human <<human>>

rectangle "ğŸ¤– **OpenAI GPT-4**\n(LLM Provider)" as llm <<external>>

' ============== FRONTEND CONTAINER ==============
package "**FRONTEND** - Streamlit UI" <<frontend>> {
    rectangle "ğŸ“Š **Case Dashboard**\nCase list, metrics,\nfiltering, status view" as dashboard
    rectangle "ğŸ’¬ **Case Copilot**\nChat interface,\nartifact display,\naudit trail" as copilot
    rectangle "ğŸ“ **Knowledge Management**\nDocument upload,\ndata ingestion" as knowledge
    rectangle "ğŸ”Œ **API Client**\nHTTP/REST communication\nor Direct imports" as api_client
}

' ============== BACKEND CONTAINER ==============
package "**BACKEND** - FastAPI Server" <<backend>> {
    
    rectangle "ğŸŒ **REST API**\n/cases, /chat, /decisions,\n/ingest, /health" as api
    
    package "**Services Layer**" {
        rectangle "ğŸ’¬ **Chat Service**\nMessage processing,\nintent handling,\nresponse formatting\n+ Conversation memory\n+ Cost estimation" as chat_svc
        rectangle "ğŸ’¾ **Conversation Context\nManager**\nContext retrieval,\nmessage storage,\ncost-aware selection" as conv_mgr
        rectangle "ğŸ“‹ **Case Service**\nCase CRUD,\nartifact management,\nstate persistence" as case_svc
        rectangle "ğŸ“¥ **Ingestion Service**\nUpload orchestration,\nvalidation" as ingest_svc
    }
    
    package "**SUPERVISOR** - Central Orchestrator" <<supervisor>> {
        rectangle "ğŸ§  **Intent Router**\nLLM-First Classification:\nâ€¢ LLM with structured output (primary)\nâ€¢ Aggressive caching (500 entries)\nâ€¢ Rule fallback (errors only)\nâ€¢ Two-level (UserGoal+WorkType)" as router
        rectangle "ğŸ“Š **State Manager**\nDTP stage tracking,\nvalidation, transitions,\nONLY state writer" as state_mgr
        rectangle "ğŸ“‹ **Action Planner**\nAgent selection,\ntask planning" as planner
    }
    
    package "**7 OFFICIAL AGENTS**" <<agent>> {
        rectangle "ğŸ“¡ **Sourcing Signal**\n(DTP-01)\nSignal detection,\nurgency scoring" as signal_agent
        rectangle "â­ **Supplier Scoring**\n(DTP-02)\nEvaluation, ranking,\neligibility checks" as supplier_agent
        rectangle "ğŸ“ **RFx Draft**\n(DTP-03)\nRFI/RFP/RFQ assembly" as rfx_agent
        rectangle "ğŸ¤ **Negotiation Support**\n(DTP-04)\nLeverage analysis,\ntargets, playbook" as negotiation_agent
        rectangle "ğŸ“„ **Contract Support**\n(DTP-05)\nTerm extraction,\nvalidation, handoff" as contract_agent
        rectangle "ğŸš€ **Implementation**\n(DTP-06)\nRollout planning,\nvalue capture" as impl_agent
    }
    
    package "**TASK EXECUTION LAYER**" <<task>> {
        rectangle "1ï¸âƒ£ **Rules**\nDeterministic checks,\npolicy validation" as task_rules
        rectangle "2ï¸âƒ£ **Retrieval**\nChromaDB + SQLite\nquery, grounding" as task_retrieval
        rectangle "3ï¸âƒ£ **Analytics**\nScoring, normalization,\ncomparison, ranking" as task_analytics
        rectangle "4ï¸âƒ£ **LLM**\nNarration, summaries\n(last resort only)" as task_llm
    }
    
    package "**ARTIFACT SYSTEM**" {
        rectangle "ğŸ“¦ **Artifact Builder**\nPack creation,\nverification status,\ngrounding references" as artifact_builder
        rectangle "ğŸ“Š **Execution Metadata**\nTokens, costs,\ntask details,\nretrieval sources" as exec_metadata
    }
    
    package "**RAG LAYER**" {
        rectangle "ğŸ” **Retriever**\nSemantic search,\nmetadata filter" as retriever
        rectangle "ğŸ“¦ **Vector Store**\nChromaDB wrapper" as vector_store
    }
    
    package "**INGESTION LAYER**" {
        rectangle "ğŸ“„ **Doc Ingest**\nPDF, DOCX, TXT\nâ†’ chunks â†’ embed" as doc_ingest
        rectangle "ğŸ“Š **Data Ingest**\nCSV, Excel\nâ†’ validate â†’ store" as data_ingest
    }
}

' ============== DATA LAYER ==============
package "**DATA LAYER** - Persistence" <<data>> {
    rectangle "ğŸ—„ï¸ **SQLite**\nData Lake\nâ€¢ Cases\nâ€¢ ArtifactPacks\nâ€¢ ChatMessages\nâ€¢ Execution Metadata\nâ€¢ Suppliers, Spend, SLAs" as sqlite
    rectangle "ğŸ§² **ChromaDB**\nVector Store\nâ€¢ Document embeddings\nâ€¢ Semantic search" as chromadb
    rectangle "ğŸ“ **Files**\nUploaded documents\nSynthetic test data" as files
}

' ============== FLOW ARROWS ==============

' Human Interaction
human --> copilot : "Asks questions,\nApproves/Rejects"
copilot --> human : "Recommendations,\nEvidence, Pending\nApproval"

human --> dashboard : "Views cases,\nselects case"
human --> knowledge : "Uploads documents\n& data files"

' Frontend to Backend
dashboard --> api_client
copilot --> api_client
knowledge --> api_client
api_client --> api : "REST API calls\nor Direct imports"

' API to Services
api --> case_svc : "Case CRUD"
api --> chat_svc : "Chat messages"
api --> ingest_svc : "File uploads"

' Chat Service to Supervisor
chat_svc --> router : "User message\n+ context"
router --> state_mgr : "Validates\nDTP stage"
router --> planner : "Two-level intent\nâ†’ Action Plan"
planner --> chat_svc : "Agent + Tasks"

' Supervisor to Agents
chat_svc --> signal_agent : "DTP-01:\nSignal detection"
chat_svc --> supplier_agent : "DTP-02:\nSupplier scoring"
chat_svc --> rfx_agent : "DTP-03:\nRFx drafting"
chat_svc --> negotiation_agent : "DTP-04:\nNegotiation support"
chat_svc --> contract_agent : "DTP-05:\nContract extraction"
chat_svc --> impl_agent : "DTP-06:\nImplementation planning"

' Agents execute Tasks (in order)
signal_agent --> task_rules : "1. Rules"
supplier_agent --> task_rules : "1. Rules"
rfx_agent --> task_rules : "1. Rules"
negotiation_agent --> task_rules : "1. Rules"
contract_agent --> task_rules : "1. Rules"
impl_agent --> task_rules : "1. Rules"

task_rules --> task_retrieval : "2. Retrieval"
task_retrieval --> task_analytics : "3. Analytics"
task_analytics --> task_llm : "4. LLM\n(if needed)"

' Agents use RAG
task_retrieval --> retriever : "Query documents"
retriever --> vector_store : "Semantic search"
vector_store --> chromadb : "Vector query"

' Agents query structured data
task_retrieval --> sqlite : "Query structured data\n(Suppliers, Spend, SLAs)"

' Agents return ArtifactPacks
signal_agent --> artifact_builder : "Build ArtifactPack"
supplier_agent --> artifact_builder : "Build ArtifactPack"
rfx_agent --> artifact_builder : "Build ArtifactPack"
negotiation_agent --> artifact_builder : "Build ArtifactPack"
contract_agent --> artifact_builder : "Build ArtifactPack"
impl_agent --> artifact_builder : "Build ArtifactPack"

' Execution Metadata tracking
signal_agent --> exec_metadata : "Track execution"
supplier_agent --> exec_metadata : "Track execution"
rfx_agent --> exec_metadata : "Track execution"
negotiation_agent --> exec_metadata : "Track execution"
contract_agent --> exec_metadata : "Track execution"
impl_agent --> exec_metadata : "Track execution"

' Artifacts return to Chat Service
artifact_builder --> chat_svc : "ArtifactPack\n+ Metadata"
exec_metadata --> artifact_builder : "Include metadata"

' Human-in-the-Loop Checkpoint
chat_svc --> state_mgr : "Check approval\nrequired?"
state_mgr --> chat_svc : "Set waiting_for_human\n= true"

' State updates (ONLY Supervisor/State Manager)
state_mgr --> sqlite : "Save case state\n(ONLY writer)"

' Artifact persistence
artifact_builder --> case_svc : "Save ArtifactPack"
case_svc --> sqlite : "Persist artifacts\n+ execution metadata"

' Conversation Memory (optional, if enabled)
chat_svc --> conv_mgr : "Get context\nSave messages"
conv_mgr --> case_svc : "Query/Save messages"
case_svc --> sqlite : "Persist ChatMessages"

' Ingestion Flow
ingest_svc --> doc_ingest : "Documents"
ingest_svc --> data_ingest : "Structured data"
doc_ingest --> vector_store : "Embed & store\nchunks"
data_ingest --> sqlite : "Validate & insert\nrecords"
doc_ingest --> files : "Store original"

' LLM Calls (only via task_llm)
task_llm --> llm : "Narration only\n(after rules/retrieval/analytics)"

' Hybrid Classification LLM call
router --> llm : "LLM Classification\n(primary, JSON mode)"

' ============== NOTES ==============
note right of router
    **LLM-First Intent Classification**
    â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    1. LLM classification (primary path)
    2. Structured output (Pydantic schema)
    3. Aggressive caching (500 entries)
    4. Two-level: UserGoal + WorkType
    5. Context-aware (DTP stage, conversation history)
    6. Rule fallback (errors only)
    7. Few-shot examples in prompt
end note

note bottom of task_rules
    **Task Execution Hierarchy**
    â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    All agents follow same order:
    1. Rules (deterministic)
    2. Retrieval (ground in data)
    3. Analytics (calculate)
    4. LLM (narrate only)
    âš ï¸ Never skip steps
end note

note right of state_mgr
    **Supervisor Governance**
    â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    â€¢ ONLY component that writes
      case state
    â€¢ Validates all transitions
    â€¢ Enforces human approval
    â€¢ Blocks invalid DTP jumps
    â€¢ Logs all changes
end note

note left of artifact_builder
    **Artifact System**
    â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    â€¢ ArtifactPacks with multiple
      artifacts
    â€¢ Verification status (VERIFIED/
      PARTIAL/UNVERIFIED)
    â€¢ Grounding references
    â€¢ Execution metadata (tokens,
      costs, task details)
    â€¢ Full audit trail
end note

note right of conv_mgr
    **Conversation Memory**
    (Optional Feature)
    â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    â€¢ Enabled via env var
    â€¢ Cost-aware context selection
    â€¢ Pre-execution cost estimation
    â€¢ Backward compatible (disabled
      by default)
    â€¢ Messages persist in database
end note

note top of human
    **Human-in-the-Loop**
    â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    âœ… Approve â†’ Advance stage
    âœï¸ Edit â†’ Modify & resubmit
    âŒ Reject â†’ Stay at stage
    
    AI advises, Human decides
end note

' ============== LEGEND ==============
legend right
    |= Color |= Component Type |
    | <#FFEBEE> | Human Actor |
    | <#E3F2FD> | Frontend (Streamlit) |
    | <#E8F5E9> | Backend (FastAPI) |
    | <#FFF3E0> | Supervisor (Orchestrator) |
    | <#F3E5F5> | Official Agents (7) |
    | <#FFF9C4> | Task Execution Layer |
    | <#ECEFF1> | Data / Persistence |
    | <#E8E8E8> | External System |
    
    **Key Governance Rules:**
    1. Supervisor is ONLY state writer
    2. Rules â†’ Retrieval â†’ Analytics â†’ LLM
    3. Hybrid classification (rules + LLM)
    4. Stage advancement requires approval
    5. All artifacts tracked with metadata
endlegend

@enduml


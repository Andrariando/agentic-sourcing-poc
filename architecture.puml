@startuml Agentic_Sourcing_Architecture

' =============================================================================
' AGENTIC SOURCING COPILOT — SYSTEM ARCHITECTURE DIAGRAM
' =============================================================================
' 
' Purpose: Visual representation of the human-in-the-loop, multi-agent 
'          decision-support system for procurement sourcing.
'
' Methodology: C4-style component diagram showing containers, components,
'              control flow, and human-in-the-loop checkpoints.
'
' To render: Use PlantUML extension in VS Code/Cursor (Alt+D) or online at
'            http://www.plantuml.com/plantuml
' =============================================================================

title Agentic Sourcing Copilot - Enterprise Architecture\nHuman-in-the-Loop Multi-Agent Decision Support System

skinparam backgroundColor #FFFFFF
skinparam defaultFontSize 11
skinparam roundcorner 10
skinparam shadowing false

skinparam rectangle {
    BackgroundColor<<human>> #FFEBEE
    BorderColor<<human>> #C62828
    BackgroundColor<<frontend>> #E3F2FD
    BorderColor<<frontend>> #1976D2
    BackgroundColor<<backend>> #E8F5E9
    BorderColor<<backend>> #388E3C
    BackgroundColor<<supervisor>> #FFF3E0
    BorderColor<<supervisor>> #F57C00
    BackgroundColor<<agent>> #F3E5F5
    BorderColor<<agent>> #7B1FA2
    BackgroundColor<<data>> #ECEFF1
    BorderColor<<data>> #546E7A
    BackgroundColor<<external>> #E8E8E8
    BorderColor<<external>> #999999
}

' ============== EXTERNAL ACTORS ==============
rectangle "Procurement Officer\n(Human Decision-Maker)" as human <<human>>

rectangle "OpenAI GPT-4\n(LLM Provider)" as llm <<external>>

' ============== FRONTEND CONTAINER ==============
package "FRONTEND - Streamlit UI" <<frontend>> {
    rectangle "Case Dashboard\nCase list, metrics,\nfiltering, status view" as dashboard
    rectangle "Case Copilot\nDecision console,\nchat interface,\napproval buttons" as copilot
    rectangle "Knowledge Management\nDocument upload,\ndata ingestion" as knowledge
    rectangle "API Client\nHTTP/Direct mode\ncommunication layer" as api_client
}

' ============== BACKEND CONTAINER ==============
package "BACKEND - FastAPI Server" <<backend>> {
    
    rectangle "REST API\n/cases, /chat, /decisions,\n/ingest, /health" as api
    
    package "Services Layer" {
        rectangle "Case Service\nCase CRUD" as case_svc
        rectangle "Chat Service\nCopilot logic" as chat_svc
        rectangle "Ingestion Service\nUpload orchestration" as ingest_svc
    }
    
    package "SUPERVISOR - Central Orchestrator" <<supervisor>> {
        rectangle "Intent Router\nClassify: EXPLAIN |\nEXPLORE | DECIDE | STATUS" as router
        rectangle "State Manager\nDTP stage tracking,\nvalidation, transitions" as state_mgr
        rectangle "LangGraph Workflow\nAgent routing,\nconditional edges" as graph
    }
    
    package "SPECIALIST AGENTS" <<agent>> {
        rectangle "Strategy Agent\n(DTP-01)\nRules -> Analytics -> LLM" as strategy
        rectangle "Supplier Agent\n(DTP-03/04)\nScoring, evaluation" as supplier
        rectangle "Negotiation Agent\n(DTP-04)\nLeverage analysis" as negotiation
        rectangle "Signal Agent\nMarket intelligence,\nrisk detection" as signal
    }
    
    package "INGESTION LAYER" {
        rectangle "Doc Ingest\nPDF, DOCX, TXT\n-> chunks -> embed" as doc_ingest
        rectangle "Data Ingest\nCSV, Excel\n-> validate -> store" as data_ingest
    }
    
    package "RAG LAYER" {
        rectangle "Retriever\nSemantic search,\nmetadata filter" as retriever
        rectangle "Vector Store\nChromaDB wrapper" as vector_store
    }
}

' ============== DATA LAYER ==============
package "DATA LAYER - Persistence" <<data>> {
    rectangle "SQLite\nData Lake\n(Suppliers, Spend,\nSLAs, Cases)" as sqlite
    rectangle "ChromaDB\nVector Store\n(Document embeddings)" as chromadb
    rectangle "JSON Files\nSynthetic seed data" as json_data
}

' ============== FLOW ARROWS ==============

' Human Interaction
human --> copilot : "Asks questions,\nApproves/Rejects"
copilot --> human : "Recommendations,\nEvidence, Pending\nApproval"

human --> dashboard : "Views cases,\nselects case"
human --> knowledge : "Uploads documents\n& data files"

' Frontend to Backend
dashboard --> api_client
copilot --> api_client
knowledge --> api_client
api_client --> api : "REST API calls\n(Separated Mode)\nor Direct imports\n(Integrated Mode)"

' API to Services
api --> case_svc : "Case CRUD"
api --> chat_svc : "Chat messages"
api --> ingest_svc : "File uploads"

' Services to Supervisor
chat_svc --> router : "Classifies\nuser intent"
router --> state_mgr : "Validates\nDTP stage"
state_mgr --> graph : "Routes to\nallowed agents"

' Supervisor to Agents
graph --> strategy : "DTP-01:\nStrategy task"
graph --> supplier : "DTP-03/04:\nEvaluate suppliers"
graph --> negotiation : "DTP-04:\nNegotiation support"
graph --> signal : "Any stage:\nInterpret signals"

' Agents return to Supervisor
strategy --> graph : "Returns structured\nrecommendation"
supplier --> graph : "Returns scored\nshortlist"
negotiation --> graph : "Returns leverage\nanalysis"
signal --> graph : "Returns risk\nassessment"

' Human-in-the-Loop Checkpoint
graph --> state_mgr : "Pauses for\nhuman approval"
state_mgr --> chat_svc : "Pending\napproval state"

' Ingestion Flow
ingest_svc --> doc_ingest : "Documents"
ingest_svc --> data_ingest : "Structured data"
doc_ingest --> vector_store : "Embed & store\nchunks"
data_ingest --> sqlite : "Validate & insert\nrecords"

' RAG Retrieval
strategy --> retriever : "Retrieves\nrelevant context"
supplier --> retriever : "Retrieves\nsupplier docs"
negotiation --> retriever : "Retrieves\ncontract terms"
signal --> retriever : "Retrieves\nmarket intel"
retriever --> vector_store : "Semantic\nsearch"
vector_store --> chromadb : "Query\nvectors"

' Data Queries
supplier --> sqlite : "Query\nperformance data"
signal --> sqlite : "Query\nspend & SLA"
state_mgr --> sqlite : "Load/save\ncase state"

' LLM Calls
strategy --> llm : "Narration only\n(after rules)"
supplier --> llm : "Summarization"
negotiation --> llm : "Insight generation"
signal --> llm : "Risk interpretation"

' Seed Data
json_data ..> sqlite : "Seed\nDemo Data"

' ============== NOTES ==============
note right of graph
    **Central Control Point**
    • Validates all state transitions
    • Blocks invalid DTP jumps
    • Enforces human approval
    • Logs all override events
end note

note bottom of strategy
    **Decision Logic Hierarchy**
    1. Heuristic / policy rules
    2. Deterministic validation
    3. Analytics (normalization)
    4. Retrieval-augmented context
    5. LLM narration (last resort)
end note

note right of human
    **Human-in-the-Loop**
    Approve -> Advance stage
    Edit -> Modify & resubmit
    Reject -> Stay at stage
end note

@enduml
